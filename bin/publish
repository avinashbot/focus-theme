#!/usr/bin/env ruby
# frozen_string_literal: true

# Ask immediately to avoid "lag"
print 'Describe your changes: '
reason = gets.chomp

require 'bundler/setup'
require 'dotenv'
require 'redd'
require 'sass'

Dotenv.load

options = {}
if ENV['SUBREDDIT'].casecmp('redd').zero?
  options['readers-word'] = '"programmers"'
  options['page-accent-color'] = '#B10DC9'
end
path = File.join(__dir__, '../theme/main.scss')
scss = File.read(path)
options.each { |option, value| scss.prepend("$#{option}: #{value};\n") }

begin
  parsed = Sass::Engine.new(scss, syntax: :scss, filename: path).render
rescue Sass::SyntaxError => e
  puts e.message
  exit 1
end

subreddit = Redd.it(
  user_agent: 'Redd:Theme Publisher:v0.1.0 (by /u/Mustermind)',
  client_id: ENV.fetch('CLIENT_ID'),
  secret: ENV.fetch('SECRET'),
  username: ENV.fetch('USERNAME'),
  password: ENV.fetch('PASSWORD')
).subreddit(ENV.fetch('SUBREDDIT'))

subreddit.update_stylesheet(parsed, reason: reason)
