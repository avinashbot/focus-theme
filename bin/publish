#!/usr/bin/env ruby
# frozen_string_literal: true

# Ask immediately to avoid "lag"
print 'Describe your changes: '
reason = gets.chomp

require 'bundler/setup'
require 'dotenv'
require 'redd'
require 'sass'

Dotenv.load

begin
  css_path = File.join(__dir__, '../theme/main.scss')
  css = Sass::Engine.for_file(css_path, {}).render

  # Yay sloppy theming
  if ENV['SUBREDDIT'].casecmp('focustheme').zero?
    css.sub!('programmers', 'themers')
  end
rescue Sass::SyntaxError => e
  puts e.message
  exit 1
end

subreddit = Redd.it(
  user_agent: 'Redd:Theme Publisher:v0.1.0 (by /u/Mustermind)',
  client_id: ENV.fetch('CLIENT_ID'),
  secret: ENV.fetch('SECRET'),
  username: ENV.fetch('USERNAME'),
  password: ENV.fetch('PASSWORD')
).subreddit(ENV.fetch('SUBREDDIT'))

subreddit.update_stylesheet(css, reason: reason)
